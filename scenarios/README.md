# シナリオファイル（.convo）について

## 概要

`.convo`ファイルは、VociMetricsで対話シナリオを定義するために使用されます。Botium形式を採用しており、ユーザーとボットの対話の流れを記述します。

## 現在の実装状況

**重要**: 現時点ではSTT（音声認識）機能がないため、`.convo`ファイルの`#bot`部分は**ボット発話のタイミング検出**のみに使用されます。実際のボット発話内容とは比較されません。

### 現在検証できること

- ✅ **ボット発話のタイミング**: VAD（Voice Activity Detection）でボット発話の開始/終了を検出
- ✅ **ユーザー発話のタイミング**: 音声ファイル送信のタイミングを記録
- ✅ **応答レイテンシ**: ユーザー発話終了からボット発話開始までの時間を測定
- ❌ **ボット発話の内容**: STTがないため、何を話したかは検証できない

### 現在検証できないこと

- ❌ ボットが期待通りの内容を話したか
- ❌ ボットの発話内容の正確性
- ❌ 発話内容の意味的な評価

## .convoファイルの書き方

### 基本形式

`.convo`ファイルは、ユーザーとボットの対話を順番に記述します。各行は以下のいずれかの形式です：

```
#me <audio_file_path>
#bot [speechStart]
#bot [speechEnd]
```

### 構文の詳細

#### 1. ユーザー発話: `#me <audio_file_path>`

ユーザーが音声ファイルを送信することを示します。

- **形式**: `#me` の後に空白を1つ以上入れ、音声ファイルのパスを指定
- **動作**: 
  - 指定された音声ファイルを読み込み、WebSocket経由で送信
  - 音声ファイルの長さ分だけ送信（10秒固定ではない）
  - 送信完了後、自動的に`USER_SPEECH_END`アクションが実行される
- **音声ファイル形式**: 
  - WAV形式（推奨）
  - サンプルレートは自動的に24000Hzにリサンプリングされる
  - モノラル/ステレオ両方に対応（ステレオの場合は自動的にモノラルに変換）

**例**:
```
#me tests/hello.wav
#me data/audio/user_input.wav
```

#### 2. ボット発話開始待機: `#bot [speechStart]`

ボットが発話を開始するまで待機します。

- **形式**: `#bot` の後に空白を1つ以上入れ、`[speechStart]`を指定
- **動作**:
  - VAD（Voice Activity Detection）でボット発話の開始を検出するまで待機
  - タイムアウト: 15秒（タイムアウトしてもシナリオは続行）
  - 検出されると`BOT_SPEECH_START`イベントが記録される

**例**:
```
#bot [speechStart]
```

#### 3. ボット発話終了待機: `#bot [speechEnd]`

ボットが発話を終了するまで待機します。

- **形式**: `#bot` の後に空白を1つ以上入れ、`[speechEnd]`を指定
- **動作**:
  - VADでボット発話の終了を検出するまで待機
  - タイムアウト: 15秒（タイムアウトしてもシナリオは続行）
  - 検出されると`BOT_SPEECH_END`イベントが記録される

**例**:
```
#bot [speechEnd]
```

#### 4. コメント行

`#`で始まる行で、`#me`や`#bot`以外のものはコメントとして扱われ、無視されます。

**例**:
```
# これはコメントです
# IVE Test Scenario
# シンプルな対話シナリオのサンプル
```

### 完全な例

以下は、3回の対話を定義する`.convo`ファイルの例です：

```
# IVE Test Scenario
# シンプルな対話シナリオのサンプル

# 1回目の対話
#me tests/hello.wav
#bot [speechStart]
#bot [speechEnd]

# 2回目の対話
#me tests/hello.wav
#bot [speechStart]
#bot [speechEnd]

# 3回目の対話
#me tests/hello.wav
#bot [speechStart]
#bot [speechEnd]
```

### 実行の流れ

上記の例の場合、以下の順序で実行されます：

1. **USER_SPEECH_START**: `tests/hello.wav`を送信開始
2. **USER_SPEECH_END**: 音声送信完了（自動）
3. **WAIT_FOR_BOT_SPEECH_START**: ボット発話開始を待機
4. **WAIT_FOR_BOT_SPEECH_END**: ボット発話終了を待機
5. （2回目、3回目の対話も同様に繰り返し）

### 注意事項

1. **音声ファイルのパス**: 
   - プロジェクトルートからの相対パスまたは絶対パスで指定
   - ファイルが存在しない場合は警告が出力され、そのアクションはスキップされる

2. **実行順序**: 
   - `.convo`ファイルに記述された順序で実行される
   - 前のアクションが完了するまで次のアクションは実行されない

3. **タイムアウト**: 
   - `WAIT_FOR_BOT_SPEECH_START`と`WAIT_FOR_BOT_SPEECH_END`は15秒でタイムアウト
   - タイムアウトしてもシナリオは続行される（エラーにはならない）

4. **音声送信**: 
   - 常に無音を送信し続けるバックグラウンドタスクが動作
   - `#me`で指定された音声ファイルは、その長さ分だけ送信される
   - 音声ファイルがない時間は自動的に無音が送信される

## 将来的な拡張

STT（Whisper等）を統合した際には、以下の機能が追加される予定です：

1. **ボット発話内容の検証**: 
   - ボット発話を音声認識してテキスト化
   - `.convo`ファイルの`#bot`部分の期待値と実際の発話内容を比較

2. **テキスト形式のサポート**: 
   - `#bot こんにちは`のような形式で期待される発話内容を記述可能に
   - 実際の発話内容との一致度を評価

3. **意味的な評価**: 
   - LLMを使用した発話内容の意味的な評価
   - 期待値との意味的な類似度を測定

## 参考

- Botium形式の`.convo`ファイル形式を採用
- `#me`: ユーザー発話
- `#bot`: ボット発話（現時点ではタイミング検出のみ）

